<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Test App - Render & Cloudflare Testing</title>
    <meta name="description" content="Comprehensive web service caching test application for Render and Cloudflare integration">
    <meta name="author" content="Cache Test Team">
    
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Favicon and Manifest -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS Files - Test Different Caching Strategies -->
    <link rel="stylesheet" href="/css/critical.css">
    <link rel="stylesheet" href="/css/vendor.css">
    <link rel="stylesheet" href="/css/styles.css">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="/js/utils.js" as="script">
    <link rel="preload" href="/js/app.js" as="script">
    <link rel="preload" href="/images/logo.svg" as="image">
    
    <!-- DNS Prefetch for APIs -->
    <link rel="dns-prefetch" href="//api.example.com">
    
    <!-- Theme Color for Mobile -->
    <meta name="theme-color" content="#2563eb">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Cache Test App">
    <meta property="og:description" content="Test Render Web Service Caching with Cloudflare">
    <meta property="og:image" content="/images/hero-bg.jpg">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cache Test App">
    <meta name="twitter:description" content="Test Render Web Service Caching with Cloudflare">
    <meta name="twitter:image" content="/images/hero-bg.jpg">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <img src="/images/logo.svg" alt="Cache Test" width="200" height="80">
                </a>
                <nav>
                    <ul>
                        <li><a href="#basic-tests">Basic Tests</a></li>
                        <li><a href="#cloudflare-tests">Cloudflare Tests</a></li>
                        <li><a href="#static-tests">Static Assets</a></li>
                        <li><a href="#comprehensive-analysis">Complete Analysis</a></li>
                        <li><a href="#analytics">Analytics</a></li>
                        <li><a href="#results">Results</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>Cache Test App</h1>
                <p>Comprehensive testing for Render's Web Service Caching with Cloudflare integration</p>
                <p class="hero-subtitle">ðŸŽ¯ Now featuring automated comprehensive cache analysis with 30+ tests</p>
                <div class="hero-buttons">
                    <a href="#comprehensive-analysis" class="btn">ðŸš€ Complete Analysis</a>
                    <a href="#basic-tests" class="btn">Manual Testing</a>
                    <a href="#analytics" class="btn btn-secondary">View Analytics</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container">
        <!-- Basic Cache Tests Section -->
        <section id="basic-tests" class="section">
            <h2 class="section-title">Basic Cache Control Tests</h2>
            <div class="test-container">
                <div class="grid grid-3">
                    <div class="card">
                        <h3>Max-Age Cache</h3>
                        <p>Test long-term caching with max-age directive</p>
                        <button class="btn test-cache-btn" data-test-type="max-age">Test Max-Age</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>S-MaxAge (CDN)</h3>
                        <p>Test CDN-specific caching (Cloudflare prioritizes this)</p>
                        <button class="btn test-cache-btn" data-test-type="s-maxage">Test S-MaxAge</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>No-Cache Test</h3>
                        <p>Test no-cache directive behavior</p>
                        <button class="btn test-cache-btn" data-test-type="no-cache">Test No-Cache</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Public Cache</h3>
                        <p>Test public cache directive</p>
                        <button class="btn test-cache-btn" data-test-type="public">Test Public</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Private Cache</h3>
                        <p>Test private cache directive</p>
                        <button class="btn test-cache-btn" data-test-type="private">Test Private</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Immutable Cache</h3>
                        <p>Test immutable cache directive</p>
                        <button class="btn test-cache-btn" data-test-type="immutable">Test Immutable</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Revalidate Test</h3>
                        <p>Test must-revalidate directive</p>
                        <button class="btn test-cache-btn" data-test-type="revalidate">Test Revalidate</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Stale While Revalidate</h3>
                        <p>Test stale-while-revalidate directive</p>
                        <button class="btn test-cache-btn" data-test-type="stale-while-revalidate">Test SWR</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>ETag Validation</h3>
                        <p>Test ETag-based conditional requests</p>
                        <button class="btn test-cache-btn" data-test-type="etag-test">Test ETag</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Vary Header Test</h3>
                        <p>Test content variation with Vary header</p>
                        <button class="btn test-cache-btn" data-test-type="vary-test">Test Vary</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cloudflare-Specific Tests Section -->
        <section id="cloudflare-tests" class="section">
            <h2 class="section-title">Cloudflare-Specific Tests</h2>
            <div class="test-container">
                <div class="grid grid-3">
                    <div class="card">
                        <h3>Query String Caching</h3>
                        <p>Test how Cloudflare handles URLs with query parameters</p>
                        <button class="btn test-special-btn" data-test-url="/api/query-string-test">Test Without Query</button>
                        <button class="btn test-special-btn" data-test-url="/api/query-string-test?v=123&test=true">Test With Query</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>File Size Tests</h3>
                        <p>Test Cloudflare's behavior with different file sizes</p>
                        <div class="file-size-buttons">
                            <button class="btn small test-size-btn" data-size="small">1KB</button>
                            <button class="btn small test-size-btn" data-size="medium">100KB</button>
                            <button class="btn small test-size-btn" data-size="large">10MB</button>
                            <button class="btn small test-size-btn" data-size="xlarge">100MB</button>
                        </div>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Range Requests</h3>
                        <p>Test partial content requests (important for large files/video)</p>
                        <button class="btn test-special-btn" data-test-url="/api/range-test">Full Request</button>
                        <button class="btn test-range-btn">Range Request</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Compression Test</h3>
                        <p>Test Cloudflare's compression handling</p>
                        <button class="btn test-special-btn" data-test-url="/api/compression-test">Test Compression</button>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Static Asset Tests Section -->
        <section id="static-tests" class="section">
            <h2 class="section-title">Static Asset Cache Tests</h2>
            <div class="test-container">
                <div class="grid grid-4">
                    <div class="card">
                        <h3>CSS Files</h3>
                        <p>Test CSS file caching behavior</p>
                        <div class="static-test-buttons">
                            <button class="btn small test-static-btn" data-url="/css/styles.css">styles.css</button>
                            <button class="btn small test-static-btn" data-url="/css/critical.css">critical.css</button>
                            <button class="btn small test-static-btn" data-url="/css/vendor.css">vendor.css</button>
                        </div>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>JavaScript Files</h3>
                        <p>Test JS file caching behavior</p>
                        <div class="static-test-buttons">
                            <button class="btn small test-static-btn" data-url="/js/app.js">app.js</button>
                            <button class="btn small test-static-btn" data-url="/js/utils.js">utils.js</button>
                            <button class="btn small test-static-btn" data-url="/js/analytics.js">analytics.js</button>
                        </div>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Images</h3>
                        <p>Test image file caching behavior</p>
                        <div class="static-test-buttons">
                            <button class="btn small test-static-btn" data-url="/images/logo.svg">logo.svg</button>
                            <button class="btn small test-static-btn" data-url="/images/hero-bg.jpg">hero-bg.jpg</button>
                            <button class="btn small test-static-btn" data-url="/favicon.ico">favicon.ico</button>
                        </div>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Other Assets</h3>
                        <p>Test other file types</p>
                        <div class="static-test-buttons">
                            <button class="btn small test-static-btn" data-url="/manifest.json">manifest.json</button>
                            <button class="btn small test-static-btn" data-url="/robots.txt">robots.txt</button>
                            <button class="btn small test-static-btn" data-url="/test-files/large-file.txt">large-file.txt</button>
                        </div>
                        <div class="cache-status">
                            <div class="status-indicator"></div>
                            <span>Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Test Results Section -->
        <section id="results" class="section">
            <h2 class="section-title">Test Results</h2>
            <div class="results-controls">
                <button class="btn" onclick="clearResults()">Clear Results</button>
                <button class="btn" onclick="exportResults()">Export Results</button>
                <button class="btn" onclick="runAllTests()">Run All Tests</button>
            </div>
            <div class="test-results">
                <div class="test-item">
                    <div class="test-name">No tests run yet</div>
                    <div class="test-result pending">Click a test button to start</div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="section">
            <h2 class="section-title">Performance Analytics</h2>
            <div class="grid grid-2">
                <div class="card">
                    <h3>Cache Performance</h3>
                    <div class="cache-info">
                        <p>Cache hit ratio: <span id="cache-hit-ratio">-</span></p>
                        <p>Average response time: <span id="avg-response-time">-</span>ms</p>
                        <p>Total requests: <span id="total-requests">-</span></p>
                        <p>Cached requests: <span id="cached-requests">-</span></p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Browser Information</h3>
                    <div class="browser-info">
                        <p>User Agent: <span id="user-agent">-</span></p>
                        <p>Online Status: <span id="online-status">-</span></p>
                        <p>Connection: <span id="connection-type">-</span></p>
                        <p>Cookies Enabled: <span id="cookies-enabled">-</span></p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Resource Timing</h3>
                    <div class="resource-timing">
                        <p>DOM Content Loaded: <span id="dcl-time">-</span>ms</p>
                        <p>Load Complete: <span id="load-time">-</span>ms</p>
                        <p>First Paint: <span id="first-paint">-</span>ms</p>
                        <p>First Contentful Paint: <span id="first-contentful-paint">-</span>ms</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Cache Usage</h3>
                    <div class="cache-usage">
                        <p>Loading cache information...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Comprehensive Cache Analysis Section -->
        <section id="comprehensive-analysis" class="section">
            <h2 class="section-title">ðŸŽ¯ Comprehensive Cache Analysis</h2>
            <div class="comprehensive-test-card">
                <div class="comprehensive-description">
                    <h3>Complete Caching Behavior Analysis</h3>
                    <p>Run a comprehensive test suite that analyzes all aspects of your caching configuration:</p>
                    <ul class="feature-list">
                        <li>âœ… All 10 basic cache control directives</li>
                        <li>âœ… Cloudflare-specific behaviors (query strings, file sizes, compression)</li>
                        <li>âœ… Static asset caching across all file types</li>
                        <li>âœ… Content type variations and edge cases</li>
                        <li>âœ… Performance analysis and recommendations</li>
                        <li>âœ… Detailed reporting with export capabilities</li>
                    </ul>
                </div>
                
                <div class="comprehensive-controls">
                    <button class="btn btn-comprehensive" onclick="comprehensiveTester.runComprehensiveTest()">
                        ðŸš€ Run Comprehensive Analysis
                    </button>
                    <div class="test-info">
                        <small>This will run ~30 tests and take approximately 2-3 minutes</small>
                    </div>
                </div>
                
                <div id="comprehensive-progress" class="progress-container" style="display: none;"></div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Cache Test App. Built for testing Render Web Service Caching with Cloudflare.</p>
            <p>
                <a href="/test.html">Advanced Tests</a> | 
                <a href="/analytics.html">Detailed Analytics</a> | 
                <a href="https://render.com/docs" target="_blank">Render Docs</a> |
                <a href="/CLOUDFLARE_CACHE_TESTING.md" target="_blank">Basic Testing Guide</a> |
                <a href="/COMPREHENSIVE_CACHE_TESTING.md" target="_blank">Comprehensive Testing Guide</a>
            </p>
        </div>
    </footer>

    <!-- JavaScript Files -->
    <script src="/js/utils.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/analytics.js"></script>
    <script src="/js/comprehensive-cache-tester.js"></script>
    
    <!-- Additional JavaScript for this page -->
    <script>
        // Global test results storage
        window.testResults = [];
        
        // Page-specific functions
        function runAllTests() {
            const basicTests = ['max-age', 's-maxage', 'no-cache', 'public', 'private', 'immutable', 'revalidate', 'stale-while-revalidate', 'etag-test', 'vary-test'];
            console.log('Running all tests...');
            
            basicTests.forEach(async (testType, index) => {
                setTimeout(async () => {
                    if (window.cacheTestApp) {
                        await window.cacheTestApp.runCacheTest(testType);
                    }
                }, index * 1000);
            });
            
            // Run special tests
            setTimeout(() => {
                if (window.cacheTestApp) {
                    window.cacheTestApp.runSpecialTest('/api/query-string-test');
                    window.cacheTestApp.runSpecialTest('/api/compression-test');
                }
            }, basicTests.length * 1000);
        }
        
        function clearResults() {
            const testResults = document.querySelector('.test-results');
            testResults.innerHTML = '<div class="test-item"><div class="test-name">Results cleared</div><div class="test-result pending">Click a test button to start</div></div>';
            window.testResults = [];
        }
        
        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                results: window.testResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cache-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Update UI with real-time data
        function updateUI() {
            // Update cache hit ratio
            fetch('/api/cache-status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cache-hit-ratio').textContent = data.performance.cacheHitRatio || '-';
                    document.getElementById('avg-response-time').textContent = data.performance.avgResponseTime || '-';
                    document.getElementById('total-requests').textContent = data.requests.total || '-';
                    document.getElementById('cached-requests').textContent = data.requests.cached || '-';
                })
                .catch(error => console.error('Failed to update cache status:', error));
            
            // Update browser info
            document.getElementById('user-agent').textContent = navigator.userAgent.split(' ')[0] || '-';
            document.getElementById('online-status').textContent = navigator.onLine ? 'Online' : 'Offline';
            document.getElementById('connection-type').textContent = 
                navigator.connection?.effectiveType || 'Unknown';
            document.getElementById('cookies-enabled').textContent = navigator.cookieEnabled ? 'Yes' : 'No';
            
            // Update performance metrics
            const navigation = performance.getEntriesByType('navigation')[0];
            if (navigation) {
                document.getElementById('dcl-time').textContent = 
                    Math.round(navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart) || '-';
                document.getElementById('load-time').textContent = 
                    Math.round(navigation.loadEventEnd - navigation.loadEventStart) || '-';
            }
            
            const paint = performance.getEntriesByType('paint');
            const firstPaint = paint.find(p => p.name === 'first-paint');
            const firstContentfulPaint = paint.find(p => p.name === 'first-contentful-paint');
            
            if (firstPaint) {
                document.getElementById('first-paint').textContent = Math.round(firstPaint.startTime) || '-';
            }
            if (firstContentfulPaint) {
                document.getElementById('first-contentful-paint').textContent = Math.round(firstContentfulPaint.startTime) || '-';
            }
        }
        
        // Initialize UI updates
        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
            
            // Update cache usage
            if (window.CacheUtils) {
                CacheUtils.displayCacheUsage();
            }
            
            // Update UI every 10 seconds
            setInterval(updateUI, 10000);
            
            // Setup comprehensive test progress tracking
            setupComprehensiveTestProgress();
        });
        
        function setupComprehensiveTestProgress() {
            // Override the updateProgress method to show/hide progress container
            if (window.comprehensiveTester) {
                const originalUpdateProgress = window.comprehensiveTester.updateProgress;
                window.comprehensiveTester.updateProgress = function(message, percentage) {
                    const progressContainer = document.getElementById('comprehensive-progress');
                    if (progressContainer) {
                        if (percentage === 0) {
                            progressContainer.style.display = 'block';
                        } else if (percentage >= 100) {
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                            }, 3000); // Hide after 3 seconds when complete
                        }
                    }
                    originalUpdateProgress.call(this, message, percentage);
                };
            }
        }
    </script>
</body>
</html>